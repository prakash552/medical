<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - Online Medical Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0073e6; /* Medical blue */
            --secondary-color: #00a3a3; /* Teal accent */
            --text-color: #333;
            --secondary-text-color: #666;
            --bg-color: #e6f0fa; /* Light blue-gray */
            --card-bg: #ffffff;
            --error-color: #d32f2f;
            font-size: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', Arial, sans-serif;
        }

        body {
            background: linear-gradient(to bottom, var(--bg-color), #ffffff);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            width: 100vw;
            overflow-x: hidden;
        }

        .hidden { display: none !important; }

        .body-no-scroll {
            overflow: hidden !important;
            position: fixed !important;
            width: 100vw;
        }

        /* Navbar */
        .navbar {
            background: linear-gradient(90deg, var(--primary-color), #005bb5);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav-logo {
            display: flex;
            align-items: center;
            color: #fff;
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
        }

        .nav-logo span {
            margin-left: 0.5rem;
            font-size: 1.25rem;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
        }

        .nav-links a {
            color: #fff;
            text-decoration: none;
            font-size: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: background 0.3s;
        }

        .nav-links a:hover,
        .nav-links a:focus {
            background: rgba(0, 0, 0, 0.2);
            outline: none;
        }

        .nav-icons {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .search-bar {
            padding: 0.625rem 1.125rem;
            border-radius: 1.5625rem;
            border: 1.5px solid #e2e8f0;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            width: 13.75rem;
            font-size: 0.9375rem;
            transition: border-color 0.3s, box-shadow 0.3s;
            outline: none;
        }

        .search-bar:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 115, 230, 0.12);
            background: #fff;
            color: var(--text-color);
        }

        .cart-icon-btn,
        .profile-icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #fff;
            font-size: 1.25rem;
        }

        .cart-icon,
        .profile-icon {
            width: 1.5rem;
            height: 1.5rem;
            filter: brightness(0) invert(1);
            transition: transform 0.3s;
        }

        .cart-icon-btn:hover .cart-icon,
        .profile-icon-btn:hover .profile-icon {
            transform: scale(1.1);
        }

        .three-dots {
            display: none;
            cursor: pointer;
            font-size: 2rem;
            color: #fff;
            background: none;
            border: none;
        }

        /* Profile Dropdown */
        .profile-dropdown {
            display: none;
            position: absolute;
            top: 3.75rem;
            right: 1rem;
            background: var(--card-bg);
            border: 1px solid #e0e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            min-width: 15rem;
            padding: 1rem;
            z-index: 1300;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .profile-dropdown.show {
            display: flex;
        }

        .profile-dropdown p {
            margin: 0.5rem 0;
            font-size: 0.875rem;
            color: var(--text-color);
            word-break: break-word;
        }

        .profile-dropdown button {
            width: 100%;
            padding: 0.625rem;
            background: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            margin: 0.25rem 0;
            transition: background 0.3s;
        }

        .profile-dropdown button:hover,
        .profile-dropdown button:focus {
            background: #005bb5;
            outline: none;
        }

        .profile-dropdown button.logout-btn {
            background: var(--error-color);
        }

        .profile-dropdown button.logout-btn:hover,
        .profile-dropdown button.logout-btn:focus {
            background: #b71c1c;
            outline: none;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal.show,
        .modal[style*="flex"] {
            display: flex !important;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 25rem;
            text-align: center;
            position: relative;
        }

        .modal-content h3 {
            margin-top: 0;
            color: var(--text-color);
            font-size: 1.5rem;
        }

        .modal-content p {
            font-size: 1rem;
            color: var(--secondary-text-color);
            margin-bottom: 1rem;
        }

        .modal-content button {
            padding: 0.625rem 1.25rem;
            background: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            margin: 0.25rem;
            font-size: 0.875rem;
            transition: background 0.3s;
        }

        .modal-content button:hover,
        .modal-content button:focus {
            background: #005bb5;
            outline: none;
        }

        .close-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
        }

        /* Orders Section */
        .orders-section {
            max-width: 62.5rem;
            margin: 7.5rem auto 1.25rem;
            padding: 0 1rem;
        }

        .orders-section h1 {
            font-size: 2rem;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .order-card {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .order-card h3 {
            font-size: 1.5rem;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }

        .order-card p {
            font-size: 1rem;
            color: var(--secondary-text-color);
            margin-bottom: 0.5rem;
        }

        .order-items {
            margin-top: 1rem;
            display: grid;
            gap: 1rem;
        }

        .order-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .order-item img {
            width: 5rem;
            height: 5rem;
            object-fit: cover;
            border-radius: 0.5rem;
        }

        .order-item img:not([src])::after {
            content: 'Image not available';
            display: block;
            font-size: 0.8rem;
            color: var(--secondary-text-color);
            text-align: center;
        }

        .order-item-details {
            flex: 1;
        }

        .no-orders {
            text-align: center;
            color: var(--secondary-text-color);
            font-size: 1.2rem;
            margin: 2rem 0;
        }

        /* Category Sidebar */
        .category-sidebar {
            display: none;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: -100vw;
            width: 80vw;
            max-width: 20rem;
            height: 100vh;
            background: linear-gradient(90deg, var(--primary-color), #005bb5);
            color: #fff;
            z-index: 2000;
            padding: 2rem 1.2rem;
            overflow-y: auto;
            transition: left 0.3s ease;
        }

        .category-sidebar.show {
            display: flex;
            left: 0;
        }

        .category-sidebar .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: #fff;
            font-size: 2rem;
            cursor: pointer;
        }

        .sidebar-category {
            margin-bottom: 1.2rem;
        }

        .sidebar-category > a {
            color: #fff;
            font-size: 1.1rem;
            font-weight: 600;
            text-decoration: none;
        }

        .sidebar-subcategories {
            margin: 0.5rem 0 0 1rem;
            padding: 0;
            list-style: disc;
        }

        .sidebar-subcategories li {
            margin-bottom: 0.3rem;
        }

        .sidebar-subcategories a {
            color: #e0f7fa;
            font-size: 1rem;
            text-decoration: none;
        }

        .sidebar-subcategories a:hover,
        .sidebar-subcategories a:focus {
            color: #b2ebf2;
            outline: none;
        }

        /* Footer */
        .footer {
            background: #2d3748;
            color: #e2e8f0;
            padding: 2rem 1rem;
            margin-top: auto;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(12.5rem, 1fr));
            gap: 2rem;
            max-width: 62.5rem;
            margin: 0 auto;
        }

        .footer-section h3 {
            color: var(--primary-color);
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
        }

        .footer-section p,
        .footer-section a {
            font-size: 0.95rem;
            color: #cbd5e1;
            text-decoration: none;
            margin-bottom: 0.5rem;
            display: block;
        }

        .footer-section a:hover,
        .footer-section a:focus {
            color: #005bb5;
            outline: none;
        }

        .footer-newsletter form {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .footer-newsletter input {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.25rem;
            flex: 1;
            font-size: 0.95rem;
        }

        .footer-newsletter button {
            padding: 0.5rem 1rem;
            background: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
        }

        .footer-newsletter button:hover,
        .footer-newsletter button:focus {
            background: #005bb5;
            outline: none;
        }

        .footer-bottom {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.9rem;
            border-top: 1px solid #4a5568;
            padding-top: 1rem;
        }

        /* Error Message */
        .error-message {
            position: fixed;
            top: 5rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-color);
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            z-index: 1100;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
        }

        .error-message.show {
            opacity: 1;
        }

        /* Spinner */
        .spinner {
            border: 2px solid #f7fafc;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .navbar {
                padding: 0.75rem 1rem;
            }

            .nav-links {
                display: none !important;
            }

            .three-dots {
                display: block !important;
            }

            .search-bar {
                width: 9.375rem;
                font-size: 0.75rem;
            }

            .orders-section {
                margin: 6.875rem auto 1.25rem;
                padding: 0 0.5rem;
            }

            .order-card {
                padding: 1rem;
            }

            .order-item img {
                width: 3.75rem;
                height: 3.75rem;
            }

            .profile-dropdown {
                top: 3.5rem;
                right: 0.5rem;
                left: 0.5rem;
                width: calc(100vw - 1rem);
            }

            .modal-content {
                max-width: 95vw;
                padding: 1rem;
            }

            .footer-content {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .footer-newsletter input {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .navbar {
                padding: 0.5rem 0.75rem;
            }

            .nav-logo {
                font-size: 1.25rem;
            }

            .nav-logo span {
                font-size: 1rem;
            }

            .search-bar {
                width: 7.5rem;
                font-size: 0.6875rem;
            }

            .orders-section h1 {
                font-size: 1.5rem;
            }

            .order-card h3 {
                font-size: 1.2rem;
            }

            .order-card p {
                font-size: 0.875rem;
            }

            .order-item img {
                width: 3rem;
                height: 3rem;
            }

            .footer-section h3 {
                font-size: 1.1rem;
            }

            .footer-section p,
            .footer-section a {
                font-size: 0.9rem;
            }
        }

        @media (min-width: 1200px) {
            .orders-section {
                max-width: 75rem;
            }

            .order-item img {
                width: 6.25rem;
                height: 6.25rem;
            }

            .order-card h3 {
                font-size: 1.75rem;
            }

            .order-card p {
                font-size: 1.125rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <button class="three-dots" id="threeDotsBtn" onclick="toggleCategorySidebar()" aria-label="Open Menu">â˜°</button>
        <a href="/" class="nav-logo">
            Online Medical Store<span>ðŸ’Š</span>
        </a>
        <div class="nav-links">
            <a href="/">Home</a>
          
            <a href="/#about">About</a>
          
            <a href="/cart" onclick="event.preventDefault(); goToCart();" aria-label="View Cart">Cart</a>
        </div>
        <div class="nav-icons">
            <input
                type="text"
                placeholder="Search orders by ID or product name..."
                class="search-bar"
                onkeyup="debounce(searchOrders, 300)(this.value)"
                aria-label="Search orders by ID or product name"
            >
            <button class="cart-icon-btn" onclick="goToCart()" aria-label="View Cart">ðŸ›’</button>
      <button class="profile-icon-btn" onclick="toggleProfile()" aria-label="Profile">ðŸ‘¤</button>
        </div>
    </nav>

    <!-- Profile Dropdown / Login Modal -->
    <div class="profile-dropdown" id="profileDropdown" style="display:none;">
        <div id="profileContent">
            <p>Loading...</p>
        </div>
        <button onclick="window.location.href='/orders'" aria-label="View Orders">My Orders</button>
        <button class="logout-btn" onclick="logout()" aria-label="Logout">Logout</button>
    </div>
    <div class="modal" id="loginModal" style="display:none;">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()" aria-label="Close Login Modal">Ã—</button>
            <h3>Please log in or register</h3>
            <p>Login or register to view your medical orders.</p>
            <button onclick="window.location.href='/login?redirect=/orders'" aria-label="Go to Login Page">Login</button>
            <button onclick="window.location.href='/register?redirect=/orders'" aria-label="Go to Register Page">Register</button>
            <p style="margin-top: 0.625rem; font-size: 0.875rem; color: var(--secondary-text-color);">
                Forgot your password? <a href="/forgot-password" style="color: var(--primary-color); text-decoration: none;">Reset it here</a>
            </p>
        </div>
    </div>

    <!-- Category Sidebar -->
    <div class="category-sidebar" id="categorySidebar">
        <button class="close-btn" onclick="toggleCategorySidebar()" aria-label="Close Sidebar">Ã—</button>
        <h3 style="margin-bottom: 1rem;">Menu</h3>
        <div class="sidebar-category">
            <a href="/"><strong>Home</strong></a>
        </div>
        
        <div class="sidebar-category">
            <a href="/#about"><strong>About</strong></a>
        </div>
       
        <div class="sidebar-category">
            <a href="/cart"><strong>Cart</strong></a>
        </div>
        <div class="sidebar-category" id="ordersSidebarLink" style="display:none;">
            <a href="/orders"><strong>My Orders</strong></a>
        </div>
        <hr style="margin: 1rem 0; border: none; border-top: 1px solid #fff; opacity: 0.2;">
        <h3 style="margin-bottom:1rem;">Categories</h3>
      
    </div>

    <!-- Orders Section -->
    <section class="orders-section">
        <h1>My Medical Orders</h1>
        <div id="ordersContainer"></div>
        <p id="noOrdersMessage" class="no-orders" style="display:none;">No orders found.</p>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>About Online Medical Store</h3>
                <p>Your trusted online pharmacy for quality medical supplies and medications.</p>
            </div>
            <div class="footer-section">
                <h3>Quick Links</h3>
                <p><a href="https://www.healthline.com" target="_blank" rel="noopener">Blog</a></p>
            </div>
            <div class="footer-section">
                <h3>Support</h3>
                <p>Email: <a href="mailto:support@onlinemedicalstore.com">support@onlinemedicalstore.com</a></p>
                <p>Phone: (+91) 1234567890</p>
            </div>
            <div class="footer-section footer-newsletter">
                <h3>Newsletter</h3>
                <p>Subscribe for updates on health products and offers!</p>
                <form onsubmit="handleNewsletterSubmit(event)">
                    <input type="email" placeholder="Enter your email" required aria-label="Email for newsletter">
                    <button type="submit" aria-label="Subscribe to newsletter">Subscribe</button>
                </form>
            </div>
        </div>
        <div class="footer-bottom">
            <p>Â© <%= new Date().getFullYear() %> Online Medical Store. All rights reserved.</p>
            <p>Website created by: <a href="mailto:info@onlinemedicalstore.com">info@onlinemedicalstore.com</a></p>
        </div>
    </footer>

    <div id="error-message" class="error-message"></div>

    <script>
let profileVisible = false;
let scrollPosition = 0;

// Use the same login check endpoint as home page
async function isUserLoggedIn() {
  try {
    const res = await fetch('/check-login', { credentials: 'include' });
    if (!res.ok) return false;
    const data = await res.json();
    return !!data.loggedIn;
  } catch {
    return false;
  }
}

// Show/hide login modal only if NOT logged in
function checkLoginBeforeAction(actionCallback) {
  isUserLoggedIn().then(isLoggedIn => {
    if (isLoggedIn) {
      actionCallback();
    } else {
      document.getElementById('loginModal').style.display = 'flex';
    }
  });
}

// Fetch user profile (same as home page)
async function fetchUserProfile() {
  try {
    const token = localStorage.getItem('token');
    const headers = token ? { Authorization: `Bearer ${token}` } : {};
    const res = await fetch('/api/users/profile', {
      method: 'GET',
      headers: {
        ...headers,
        'Content-Type': 'application/json',
      },
      credentials: 'include',
    });
    if (!res.ok) throw new Error('HTTP error! Status: ' + res.status);
    const data = await res.json();
    return data.success && data.user ? data.user : null;
  } catch (error) {
    return null;
  }
}

function encodeHTML(str) {
  return String(str).replace(/[&<>"']/g, function (match) {
    return ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    })[match];
  });
}

// Render profile dropdown (same as home page)
async function renderProfileDropdown() {
  const dropdown = document.getElementById('profileDropdown');
  let content = document.getElementById('profileContent');
  if (!dropdown) return;
  // If profileContent div doesn't exist, create it
  if (!content) {
    content = document.createElement('div');
    content.id = 'profileContent';
    dropdown.prepend(content);
  }
  content.innerHTML = '<div class="spinner"></div>';
  const user = await fetchUserProfile();
  if (user) {
    const safeName = user.name ? encodeHTML(user.name) : 'Not provided';
    const safeEmail = user.email ? encodeHTML(user.email) : 'Not provided';
    const safePhone = user.phone ? encodeHTML(user.phone) : 'Not provided';
    let safeAddress = 'Not provided';
    if (user.address && (
      user.address.street ||
      user.address.city ||
      user.address.state ||
      user.address.pinCode ||
      user.address.country
    )) {
      safeAddress = encodeHTML([
        user.address.street,
        user.address.city,
        user.address.state,
        user.address.pinCode,
        user.address.country
      ].filter(Boolean).join(', '));
    } else if (Array.isArray(user.addresses) && user.addresses[0]) {
      safeAddress = encodeHTML([
        user.addresses[0].street,
        user.addresses[0].city,
        user.addresses[0].state,
        user.addresses[0].pinCode,
        user.addresses[0].country
      ].filter(Boolean).join(', '));
    }
    content.innerHTML = `
      <p><strong>Name:</strong> ${safeName}</p>
      <p><strong>Email:</strong> ${safeEmail}</p>
      <p><strong>Phone:</strong> ${safePhone}</p>
      <p><strong>Address:</strong> ${safeAddress}</p>
    `;
  } else {
    content.innerHTML = `<p>Error loading profile. Please try again or log in.</p>`;
  }
}

// Toggle profile dropdown (same as home page)
async function toggleProfile() {
  const dropdown = document.getElementById('profileDropdown');
  if (!dropdown) return;
  const isLoggedIn = await isUserLoggedIn();
  if (!isLoggedIn) {
    document.getElementById('loginModal').style.display = 'flex';
    return;
  }
  profileVisible = !profileVisible;
  dropdown.classList.toggle('show', profileVisible);
  dropdown.style.display = profileVisible ? 'flex' : 'none';
  if (profileVisible) await renderProfileDropdown();
}

// On DOMContentLoaded, fetch profile and orders if logged in
document.addEventListener('DOMContentLoaded', async () => {
  const isLoggedIn = await isUserLoggedIn();
  const loginModal = document.getElementById('loginModal');
  if (isLoggedIn) {
    if (loginModal) {
      loginModal.style.display = 'none';
      document.body.classList.remove('body-no-scroll');
    }
    await renderProfileDropdown();
    await fetchAndRenderOrders();
  } else {
    if (loginModal) {
      loginModal.style.display = 'flex';
      document.body.classList.add('body-no-scroll');
    }
  }
});

    </script>
</body>
</html>